name: Validate SPID Metadata

on:
  push:
    paths:
      - "metadata/**.xml"
  pull_request:
    paths:
      - "metadata/**.xml"

permissions:
  contents: write   # ‚úÖ necessario per push su gh-pages

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install lxml xmlsec cryptography

      - name: Run metadata validation
        run: |
          set +e   # üëà disabilita 'exit on error'
          mkdir -p validated reports
          echo "=== Validation Report ===" > reports/report.log
          EXIT_CODE=0
          for f in metadata/*.xml; do
            echo "üîé Validating $f"
            python scripts/validate_metadata_qad.py "$f" >> reports/report.log 2>&1
            if [ $? -eq 0 ]; then
              echo "‚úÖ $f is valid"
              cp "$f" validated/
            else
              echo "‚ùå $f has errors"
              EXIT_CODE=1
            fi
          done
          exit 0


      - name: Generate index.html
        run: |
          cat > gh-pages_index.html <<'EOF'
          <!DOCTYPE html>
          <html lang="it">
          <head>
            <meta charset="UTF-8">
            <title>Registro SPID - Metadata Validati</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 2em; background: #f9f9f9; }
              h1 { color: #2c3e50; }
              table { border-collapse: collapse; width: 100%; margin-top: 1em; }
              th, td { padding: 8px 12px; border: 1px solid #ccc; }
              th { background: #34495e; color: #fff; text-align: left; }
              tr:nth-child(even) { background: #ecf0f1; }
              .footer { margin-top: 2em; font-size: 0.9em; color: #777; }
            </style>
          </head>
          <body>
            <h1>Registro SPID - Metadata Validati ‚úÖ</h1>
            <p>Questa pagina elenca i metadata validati e pubblicati automaticamente tramite pipeline CI/CD.</p>

            <h2>Metadata disponibili</h2>
            <table>
              <thead>
                <tr>
                  <th>Nome file</th>
                  <th>Ultimo aggiornamento</th>
                </tr>
              </thead>
              <tbody>
          EOF

          for f in validated/*.xml; do
            DATE=$(date +"%Y-%m-%d")
            echo "<tr><td><a href=\"$(basename $f)\">$(basename $f)</a></td><td>$DATE</td></tr>" >> gh-pages_index.html
          done

          cat >> gh-pages_index.html <<'EOF'
              </tbody>
            </table>

            <h2>Report di validazione</h2>
            <p><a href="report.log">üìÑ Scarica il report completo</a></p>

            <div class="footer">
              Generato automaticamente dal workflow GitHub Actions ‚Üí
              <code>gh-pages</code>
            </div>
          </body>
          </html>
          EOF

      - name: Setup Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Deploy validated metadata to gh-pages
        run: |
          git fetch origin
          git checkout gh-pages || git checkout --orphan gh-pages
          rm -rf ./*
          cp -r validated/* . || echo "‚ö†Ô∏è Nessun metadata valido trovato"
          cp reports/report.log .
          cp gh-pages_index.html index.html
          touch .nojekyll
          git add .
          git commit -m "Update validated metadata [skip ci]" || echo "No changes to commit"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }} gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

