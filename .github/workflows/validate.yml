name: Validate SPID Metadata

on:
  push:
    paths:
      - "metadata/**.xml"
  pull_request:
    paths:
      - "metadata/**.xml"

permissions:
  contents: write   # ‚úÖ necessario per push su gh-pages

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install lxml xmlsec cryptography

      - name: Run metadata validation
        run: |
          mkdir -p validated reports .gh-pages-tmp
          echo "=== Validation Report ===" > reports/report.log
          set +e   # non fermarti al primo errore
          for f in metadata/*.xml; do
            echo "üîé Validating $f"
            if python scripts/validate_metadata_qad.py "$f" >> reports/report.log 2>&1; then
              echo "‚úÖ $f is valid"
              cp "$f" validated/
            else
              echo "‚ùå $f has errors"
            fi
          done
          # Salva gli output in una cartella temporanea (sopravvive al checkout gh-pages)
          cp -r validated reports gh-pages_index.html .gh-pages-tmp/

      - name: Setup Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Deploy validated metadata to gh-pages
        run: |
          git fetch origin
          git checkout gh-pages || git checkout --orphan gh-pages
          rm -rf ./*

          # Recupera i file dalla cartella temporanea
          cp -r .gh-pages-tmp/validated/* . 2>/dev/null || echo "‚ö†Ô∏è Nessun metadata valido trovato"
          cp .gh-pages-tmp/reports/report.log . 2>/dev/null || echo "‚ö†Ô∏è Nessun report trovato"
          cp .gh-pages-tmp/gh-pages_index.html index.html || echo "‚ö†Ô∏è Nessun index generato"

          touch .nojekyll   # ‚úÖ disabilita Jekyll su GitHub Pages

          git add .
          git commit -m "Update validated metadata [skip ci]" || echo "No changes to commit"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }} gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
