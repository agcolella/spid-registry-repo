name: Validate and publish SPID Metadata

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      files: ${{ steps.set-matrix.outputs.files }}
    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - id: set-matrix
      run: |
        files=$(ls metadata/*.xml | jq -R -s -c 'split("\n")[:-1]')
        echo "files=$files" >> $GITHUB_OUTPUT

  validate:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        file: ${{ fromJson(needs.discover.outputs.files) }}

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y xmlsec1 openssl jq
        python3 -m pip install lxml cryptography certifi

    - name: Validate SPID metadata with QAD rules
      run: |
        echo "ðŸ”Ž Validating ${{ matrix.file }}"
        python3 scripts/validate_metadata_qad.py "${{ matrix.file }}"

    - name: Collect results
      if: always()
      run: |
        mkdir -p results
        for f in metadata/*.xml; do
          echo "Processing $f"
          if python3 scripts/validate_metadata_qad.py "$f" > out.log 2>&1; then
            echo "$f;OK;Valid" >> results/results.txt
          else
            details=$(tail -n 5 out.log | tr '\n' ' ')
            echo "$f;FAIL;$details" >> results/results.txt
          fi
        done

    - name: Generate HTML report
      run: |
        python3 scripts/generate_status_html.py results/results.txt status.html

    - name: Deploy status.html to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        publish_branch: gh-pages
        force_orphan: true
        keep_files: false
